(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{132:function(t,s,n){t.exports=n.p+"assets/img/y1.22b53d3f.jpg"},264:function(t,s,n){"use strict";n.r(s);var a=n(0),e=Object(a.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"js-引擎的执行机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#js-引擎的执行机制","aria-hidden":"true"}},[t._v("#")]),t._v(" JS 引擎的执行机制")]),t._v(" "),a("p",[t._v("web 前端开发 2018-08-22")]),t._v(" "),a("p",[t._v("作者 | ziwei3749\n来源 | https://segmentfault.com/a/1190000012806637")]),t._v(" "),a("p",[t._v("首先，请牢记 2 点：")]),t._v(" "),a("ul",[a("li",[t._v("JS 是单线程语言")]),t._v(" "),a("li",[t._v("JS 的 Event Loop 是 JS 的执行机制。深入了解 JS 的执行，就等于深入了解 JS 里的 event loop")])]),t._v(" "),a("h4",{attrs:{id:"_1、灵魂三问：js-为什么是单线程的？为什么需要异步？单线程又是如何实现异步的呢？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、灵魂三问：js-为什么是单线程的？为什么需要异步？单线程又是如何实现异步的呢？","aria-hidden":"true"}},[t._v("#")]),t._v(" 1、灵魂三问：JS 为什么是单线程的？为什么需要异步？单线程又是如何实现异步的呢？")]),t._v(" "),a("p",[a("strong",[t._v("(1) JS 为什么是单线程的？")])]),t._v(" "),a("p",[t._v("JS 最初被设计用在浏览器中，那么想象一下，如果浏览器中的 JS 是多线程的。")]),t._v(" "),a("p",[t._v("场景描述：")]),t._v(" "),a("blockquote",[a("p",[t._v("那么现在有 2 个进程，process1 process2，由于是多进程的 JS，所以他们对同一个 dom，同时进行操作。 process1 删除了该 dom，而 process2 编辑了该 dom，同时下达 2 个矛盾的命令，浏览器究竟该如何执行呢？")])]),t._v(" "),a("p",[t._v("这样想，JS 为什么被设计成单线程应该就容易理解了吧。")]),t._v(" "),a("p",[a("strong",[t._v("(2) JS 为什么需要异步?")])]),t._v(" "),a("p",[t._v("场景描述：")]),t._v(" "),a("blockquote",[a("p",[t._v('如果 JS 中不存在异步，只能自上而下执行，如果上一行解析时间很长，那么下面的代码就会被阻塞。 对于用户而言，阻塞就意味着"卡死"，这样就导致了很差的用户体验。')])]),t._v(" "),a("p",[t._v("所以，JS 中存在异步执行。")]),t._v(" "),a("p",[a("strong",[t._v("(3) JS 单线程又是如何实现异步的呢？")])]),t._v(" "),a("p",[t._v("既然 JS 是单线程的，只能在一条线程上执行，又是如何实现的异步呢？")]),t._v(" "),a("p",[t._v("是通过的事件循环(event loop)，理解了 event loop 机制，就理解了 JS 的执行机制。")]),t._v(" "),a("h4",{attrs:{id:"_2、js-中的-event-loop-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、js-中的-event-loop-1","aria-hidden":"true"}},[t._v("#")]),t._v(" 2、JS 中的 event loop(1)")]),t._v(" "),a("p",[t._v("例 1,观察它的执行顺序")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("运行结果是：1 3 2")]),t._v(" "),a("p",[t._v("也就是说，setTimeout 里的函数并没有立即执行，而是延迟了一段时间，满足一定条件后才去执行的，这类代码，我们叫异步代码。")]),t._v(" "),a("p",[t._v("所以，这里我们首先知道了 JS 里的一种分类方式，就是将任务分为：同步任务和异步任务。")]),t._v(" "),a("p",[t._v("按照这种分类方式:JS 的执行机制是：")]),t._v(" "),a("ul",[a("li",[t._v("首先判断 JS 是同步还是异步，同步就进入主进程，异步就进入 event table")]),t._v(" "),a("li",[t._v("异步任务在 event table 中注册函数，当满足触发条件后，被推入 event queue")]),t._v(" "),a("li",[t._v("同步任务进入主线程后一直执行，直到主线程空闲时，才会去 event queue 中查看是否有可执行的异步任务，如果有就推入主进程中\n以上三步循环执行，这就是 event loop。")])]),t._v(" "),a("p",[t._v("所以上面的例子，你是否可以描述它的执行顺序了呢？")]),t._v(" "),a("ul",[a("li",[t._v("console.log(1) 是同步任务，放入主线程里")]),t._v(" "),a("li",[t._v("setTimeout() 是异步任务，被放入 event table， 0 秒之后被推入 event queue 里")]),t._v(" "),a("li",[t._v("console.log(3 是同步任务，放到主线程里\n当 1、 3 在控制条被打印后，主线程去 event queue(事件队列)里查看是否有可执行的函数，执行 setTimeout 里的函数。")])]),t._v(" "),a("h4",{attrs:{id:"_3、js-中的-event-loop-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、js-中的-event-loop-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 3、JS 中的 event loop(2)")]),t._v(" "),a("p",[t._v("所以，上面关于 event loop 就是我对 JS 执行机制的理解，直到我遇到了下面这段代码。")]),t._v(" "),a("p",[t._v("例 2：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"定时器开始啦"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"马上执行 for 循环啦"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("99")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"执行 then 函数啦"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"代码执行结束"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("尝试按照，上文我们刚学到的 JS 执行机制去分析：")]),t._v(" "),a("ul",[a("li",[t._v("setTimeout 是异步任务，被放到 event table")]),t._v(" "),a("li",[t._v("new Promise 是同步任务，被放到主进程里，直接执行打印 console.log('马上执行 for 循环啦')")]),t._v(" "),a("li",[t._v(".then 里的函数是异步任务，被放到 event table")]),t._v(" "),a("li",[t._v("console.log('代码执行结束') 是同步代码，被放到主进程里，直接执行\n所以，结果是： "),a("strong",[t._v("马上执行 for 循环啦---代码执行结束---定时器开始啦---执行 then 函数啦吗?")]),t._v("\n亲自执行后，结果居然不是这样，而是："),a("strong",[t._v("马上执行 for 循环啦---代码执行结束---执行 then 函数啦---定时器开始啦")]),t._v("\n那么，难道是异步任务的执行顺序，不是前后顺序，而是另有规定？事实上，按照异步和同步的划分方式，并不准确。")])]),t._v(" "),a("p",[t._v("而准确的划分方式是：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("macro-task(宏任务)：包括整体代码 script，setTimeout，setInterval")])]),t._v(" "),a("li",[a("p",[t._v("micro-task(微任务)：Promise，process.nextTick\n"),a("img",{attrs:{src:n(132),alt:"img"}}),t._v("\n按照这种分类方式，JS 的执行机制是：")])]),t._v(" "),a("li",[a("p",[t._v("执行一个宏任务，过程中如果遇到微任务，就将其放到微任务的“事件队列”里")])]),t._v(" "),a("li",[a("p",[t._v("当前宏任务执行完成后，会查看微任务的“事件队列”，并将里面全部的微任务依次执行完")])]),t._v(" "),a("li",[a("p",[t._v("重复以上 2 步骤，结合 event loop(1) event loop(2)，就是更为准确的 JS 执行机制了")])])]),t._v(" "),a("p",[a("strong",[t._v("尝试按照刚学的执行机制，去分析例 2：")])]),t._v(" "),a("ul",[a("li",[t._v("首先执行 script 下的宏任务，遇到 setTimeout,将其放到宏任务的“队列”里")]),t._v(" "),a("li",[t._v('遇到 new Promise 直接执行，打印"马上执行 for 循环啦"')]),t._v(" "),a("li",[t._v("遇到 then 方法，是微任务，将其放到微任务的“队列”里。")]),t._v(" "),a("li",[t._v('打印 "代码执行结束"')]),t._v(" "),a("li",[t._v('本轮宏任务执行完毕，查看本轮的微任务，发现有一个 then 方法里的函数，打印"执行 then 函数啦"')]),t._v(" "),a("li",[t._v("到此,本轮的 event loop 全部完成。")]),t._v(" "),a("li",[t._v('下一轮的循环里，先执行一个宏任务，发现宏任务的“队列”里有一个 setTimeout 里的函数,执行打印"定时器开始啦"\n所以最后的执行顺序是： '),a("strong",[t._v("马上执行 for 循环啦---代码执行结束---执行 then 函数啦---定时器开始啦")])])]),t._v(" "),a("h4",{attrs:{id:"_4、谈谈-settimeout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、谈谈-settimeout","aria-hidden":"true"}},[t._v("#")]),t._v(" 4、谈谈 setTimeout")]),t._v(" "),a("p",[t._v("这段 setTimeout 代码什么意思? 我们一般说: 3 秒后,会执行 setTimeout 里的那个函数")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"执行了"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("但是这种说并不严谨，准确的解释是：3 秒后，setTimeout 里的函数被会推入 event queue，而 event queue(事件队列)里的任务，只有在主线程空闲时才会执行。")]),t._v(" "),a("p",[a("strong",[t._v("所以只有满足")])]),t._v(" "),a("p",[t._v("(1) 3 秒后")]),t._v(" "),a("p",[t._v("(2) 主线程空闲，同时满足时，才会 3 秒后执行该函数")]),t._v(" "),a("p",[t._v("如果主线程执行内容很多，执行时间超过 3 秒，比如执行了 10 秒，那么这个函数只能 10 秒后执行了。")])])},[],!1,null,null,null);s.default=e.exports}}]);